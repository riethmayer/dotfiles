#!/usr/bin/env bash
# Stop hook for brag-book - captures conversation summary

set -euo pipefail

# Source the shared library (resolve symlinks)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
source "$SCRIPT_DIR/brag-lib.sh"

# Read hook input from stdin
HOOK_INPUT=$(cat)

# Extract transcript path
TRANSCRIPT_PATH=$(echo "$HOOK_INPUT" | jq -r '.transcript_path // empty')

if [[ -z "$TRANSCRIPT_PATH" || ! -f "$TRANSCRIPT_PATH" ]]; then
  echo '{"ok": true, "systemMessage": "Brag: no transcript"}'
  exit 0
fi

# Simple summary: session ended
SUMMARY="session ended"

# Extract hook metadata
SESSION_ID=$(echo "$HOOK_INPUT" | jq -r '.session_id // "unknown"')
PERMISSION_MODE=$(echo "$HOOK_INPUT" | jq -r '.permission_mode // "default"')

# Create extra metadata JSON
EXTRA_JSON=$(jq -n \
  --arg sid "$SESSION_ID" \
  --arg mode "$PERMISSION_MODE" \
  '{session_id: $sid, permission_mode: $mode}')

# Write the entry using shared function
brag_write_entry "$SUMMARY" "claude-hook" "$EXTRA_JSON"

# Return success (properly escape summary for JSON)
jq -n --arg msg "Brag: $SUMMARY" '{"ok": true, "systemMessage": $msg}'
