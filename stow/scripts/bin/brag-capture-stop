#!/usr/bin/env bash
# Stop hook for brag-book - captures conversation summary

set -euo pipefail

# Source the shared library (resolve symlinks)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
source "$SCRIPT_DIR/brag-lib.sh"

# Read hook input from stdin
HOOK_INPUT=$(cat)

# Extract transcript path
TRANSCRIPT_PATH=$(echo "$HOOK_INPUT" | jq -r '.transcript_path // empty')

if [[ -z "$TRANSCRIPT_PATH" || ! -f "$TRANSCRIPT_PATH" ]]; then
  echo '{"ok": true, "systemMessage": "Brag: no transcript"}'
  exit 0
fi

# Read transcript (last 50 lines)
TRANSCRIPT=$(tail -50 "$TRANSCRIPT_PATH")

if [[ -z "$TRANSCRIPT" ]]; then
  echo '{"ok": true, "systemMessage": "Brag: empty transcript"}'
  exit 0
fi

# Check if claude CLI is available
if ! command -v claude &> /dev/null; then
  echo '{"ok": true, "systemMessage": "Brag: claude CLI not found"}'
  exit 0
fi

# Call Claude via CLI for structured JSON summary
ESCAPED_TRANSCRIPT=$(jq -Rs '.' <<< "$TRANSCRIPT")
CLAUDE_RESPONSE=$(claude -p "Summarize this coding session in one concise line.

Respond with ONLY valid JSON in this exact format:
{\"summary\": \"<one line summary here>\"}

Transcript:
$ESCAPED_TRANSCRIPT" 2>&1)

# Extract summary from JSON response, fallback to raw response if not valid JSON
SUMMARY=$(echo "$CLAUDE_RESPONSE" | jq -r '.summary // empty' 2>/dev/null)
if [[ -z "$SUMMARY" ]]; then
  # Fallback: use raw response, strip any markdown code blocks
  SUMMARY=$(echo "$CLAUDE_RESPONSE" | sed 's/^```json//;s/^```//;s/```$//' | tr -d '\n' | head -c 200)
fi

if [[ -z "$SUMMARY" ]]; then
  echo '{"ok": true, "systemMessage": "Brag: summary failed"}'
  exit 0
fi

# Extract hook metadata
SESSION_ID=$(echo "$HOOK_INPUT" | jq -r '.session_id // "unknown"')
PERMISSION_MODE=$(echo "$HOOK_INPUT" | jq -r '.permission_mode // "default"')

# Create extra metadata JSON
EXTRA_JSON=$(jq -n \
  --arg sid "$SESSION_ID" \
  --arg mode "$PERMISSION_MODE" \
  '{session_id: $sid, permission_mode: $mode}')

# Write the entry using shared function
brag_write_entry "$SUMMARY" "claude-hook" "$EXTRA_JSON"

# Return success (properly escape summary for JSON)
jq -n --arg msg "Brag: $SUMMARY" '{"ok": true, "systemMessage": $msg}'
