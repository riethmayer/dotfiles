#!/usr/bin/env bash
# Stop hook for brag-book - captures conversation summary

set -euo pipefail

# Source the shared library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/brag-lib.sh"

# Read hook input from stdin
HOOK_INPUT=$(cat)

# Extract transcript path
TRANSCRIPT_PATH=$(echo "$HOOK_INPUT" | jq -r '.transcript_path // empty')

if [[ -z "$TRANSCRIPT_PATH" || ! -f "$TRANSCRIPT_PATH" ]]; then
  echo '{"ok": true, "systemMessage": "Brag: no transcript"}'
  exit 0
fi

# Read transcript (last 50 lines)
TRANSCRIPT=$(tail -50 "$TRANSCRIPT_PATH")

if [[ -z "$TRANSCRIPT" ]]; then
  echo '{"ok": true, "systemMessage": "Brag: empty transcript"}'
  exit 0
fi

# Check if claude CLI is available
if ! command -v claude &> /dev/null; then
  echo '{"ok": true, "systemMessage": "Brag: claude CLI not found"}'
  exit 0
fi

# Call Claude via CLI for summary only
ESCAPED_TRANSCRIPT=$(jq -Rs '.' <<< "$TRANSCRIPT")
SUMMARY=$(claude -p "Summarize this conversation in one concise line. Respond with ONLY the summary text, no JSON.

Transcript:
$ESCAPED_TRANSCRIPT" 2>&1)

if [[ $? -ne 0 || -z "$SUMMARY" ]]; then
  echo '{"ok": true, "systemMessage": "Brag: summary failed"}'
  exit 0
fi

# Extract hook metadata
SESSION_ID=$(echo "$HOOK_INPUT" | jq -r '.session_id // "unknown"')
PERMISSION_MODE=$(echo "$HOOK_INPUT" | jq -r '.permission_mode // "default"')

# Create extra metadata JSON
EXTRA_JSON=$(jq -n \
  --arg sid "$SESSION_ID" \
  --arg mode "$PERMISSION_MODE" \
  '{session_id: $sid, permission_mode: $mode}')

# Write the entry using shared function
brag_write_entry "$SUMMARY" "claude-hook" "$EXTRA_JSON"

# Return success
echo "{\"ok\": true, \"systemMessage\": \"Brag: $SUMMARY\"}"
