#!/usr/bin/env bash
# Capture brag entry from prompt hook output

set -euo pipefail

BRAG_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/brag-book"
TODAY=$(date +%Y-%m-%d)
TIMESTAMP=$(date +%H:%M)

# Read JSON from stdin (output from prompt hook)
INPUT=$(cat)

# Parse JSON (simple extraction)
CATEGORY=$(echo "$INPUT" | grep -o '"category"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
SUMMARY=$(echo "$INPUT" | grep -o '"summary"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)

# Validate category
if [[ ! "$CATEGORY" =~ ^(strategy|culture|execution)$ ]]; then
  CATEGORY="execution"
fi

# Ensure directory and file exist
mkdir -p "$BRAG_DIR/$CATEGORY"
FILE="$BRAG_DIR/$CATEGORY/$TODAY.md"
if [[ ! -f "$FILE" ]]; then
  echo "# ${CATEGORY^} - $TODAY" > "$FILE"
  echo "" >> "$FILE"
fi

# Append entry
echo "- [$TIMESTAMP] $SUMMARY" >> "$FILE"

# Return feedback
cat <<EOF
{
  "continue": true,
  "systemMessage": "Brag: $CATEGORY ($TIMESTAMP): $SUMMARY"
}
EOF
